{% extends "public.html" %} {% block page %}
<div class="text-h6">
  <span v-text="publicPageName"></span> -
  <small><span v-text="publicPageDescription"></span></small>
</div>
<div class="row q-col-gutter-md justify-center items-stretch window-height">
  <div
    v-for="stage in stages"
    :key="stage"
    class="col-12 col-sm-4 col-md-4 col-lg-4 q-gutter-y-md column justify-between full-height"
    @dragover.prevent
    @drop="handleDrop(stage)"
  >
    <q-card class="full-height">
      <q-card-section>
        <div class="row">
          <div class="col">
            <h6 class="q-mb-sm q-mt-none" v-text="stageLabels[stage]"></h6>
          </div>
          <div class="col">
            <q-btn
              v-if="publicTasksCreation && stage === 'todo'"
              dense
              color="primary"
              icon="add"
              round
              class="float-right"
              @click="addTask()"
            ></q-btn>
          </div>
        </div>
        <q-list
          bordered
          class="rounded-borders q-mb-md"
          v-for="task in tasksBy(stage)"
          :key="task.id"
          :draggable="canDrag(task)"
          @dragstart="onDragStart($event, task)"
        >
          <q-expansion-item
            expand-separator
            :label="task.task"
            :icon="task.complete ? 'check_circle' : ''"
            switch-toggle-side
          >
            <q-card class="my-card" flat bordered>
              <q-card-section horizontal>
                <q-card-section class="q-pt-xs">
                  <div class="row items-center">
                    <q-icon
                      v-if="task.complete"
                      class="q-pl-md"
                      color="green"
                      name="check"
                    ></q-icon>
                  </div>
                  <div
                    class="text-caption text-grey"
                    v-if="task.notes"
                    v-text="task.notes"
                    style="white-space: pre-line"
                  ></div>
                </q-card-section>
              </q-card-section>
              <q-card-actions align="right">
                <div class="on-left text-caption text-grey">
                  <span v-text="task.assignee"></span>
                  <span
                    v-if="task.reward > 0 && !task.complete"
                    v-text="' for ' + task.reward.toString() + 'sats reward'"
                  ></span>
                  <span
                    v-if="task.reward > 0 && task.complete"
                    v-text="' (' + task.reward.toString() + 'sats rewarded)'"
                  ></span>
                </div>
                <q-btn
                  flat
                  @click="editTask(task)"
                  icon="edit"
                  color="light-blue"
                ></q-btn>
              </q-card-actions>
            </q-card>
          </q-expansion-item>
        </q-list>
      </q-card-section>
    </q-card>
  </div>
  <q-dialog v-model="tasksFormDialog.show" position="top">
    <q-card
      v-if="tasksFormDialog.show"
      class="q-pa-lg q-pt-md lnbits__dialog-card q-col-gutter-md"
    >
      <q-input
        v-if="publicAssigning"
        filled
        dense
        v-model.trim="tasksFormDialog.data.assignee"
        label="Assignee (LNaddress if task has paid reward)"
      ></q-input>

      <q-input
        filled
        dense
        v-model.trim="tasksFormDialog.data.notes"
        label="Notes"
        type="textarea"
        hint="Any useful notes"
      ></q-input>

      <div class="row q-mt-lg">
        <q-btn
          @click="updateTask(tasksFormDialog.data)"
          label="Update"
          unelevated
          color="primary"
        >
        </q-btn>
        <q-btn v-close-popup flat color="grey" class="q-ml-auto">Cancel</q-btn>
      </div>
    </q-card>
  </q-dialog>
  <q-dialog v-model="addTaskFormDialog.show" position="top">
    <q-card
      v-if="addTaskFormDialog.show"
      class="q-pa-lg q-pt-md lnbits__dialog-card q-col-gutter-md"
    >
      <q-input
        v-if="publicAssigning"
        filled
        dense
        v-model.trim="addTaskFormDialog.data.assignee"
        label="Assignee"
      ></q-input>
      <q-input
        filled
        dense
        v-model.trim="addTaskFormDialog.data.name"
        label="Task"
        hint="Task name"
      ></q-input>

      <q-input
        filled
        dense
        v-model.trim="addTaskFormDialog.data.notes"
        label="Notes"
        type="textarea"
        hint="Any useful notes"
      ></q-input>

      <div class="row q-mt-lg">
        <q-btn
          @click="createTask(addTaskFormDialog.data)"
          label="Add"
          unelevated
          color="primary"
        >
        </q-btn>
        <q-btn v-close-popup flat color="grey" class="q-ml-auto">Cancel</q-btn>
      </div>
    </q-card>
  </q-dialog>
</div>
{% endblock %} {% block scripts %}
<script>
    public_page_tasks = {{ public_page_tasks | safe }}
    public_page_assigning = {{ public_page_assigning | tojson | safe }}
    scrum_id = '{{ scrum_id }}'
    public_page_name = '{{ public_page_name }}'
    public_page_description = '{{ public_page_description }}'
    public_page_tasks_creation = {{ public_page_tasks_creation | tojson | safe }}
    window.app = Vue.createApp({
      mixins: [windowMixin],
      data() {
        return {
          publicPageName: public_page_name,
          publicPageDescription: public_page_description,
          scrumId: scrum_id,
          publicTasks: Array.isArray(public_page_tasks) ? public_page_tasks.filter(Boolean) : [],
          draggingTaskId: null,
          stages: ['todo','doing','done'],
          stageLabels: { todo: 'To do', doing: 'Doing', done: 'Done' },
          tasksFormDialog: { show: false, data: {} },
          addTaskFormDialog: { show: false, data: {} },
          publicAssigning: public_page_assigning,
          publicTasksCreation: public_page_tasks_creation
        }
      },
      methods: {
    tasksBy(stage) {
      return this.publicTasks.filter(t => t && t.stage === stage)
    },

    canDrag(task) {
      return !(task && task.complete && task.stage === 'done')
    },

    onDragStart(evt, task) {
      if (!this.canDrag(task)) {
        evt.preventDefault()
        evt.stopPropagation()
        return
      }
      this.draggingTaskId = task.id
    },

    async handleDrop(targetStage) {
      if (!this.draggingTaskId) return
      const id = this.draggingTaskId
      this.draggingTaskId = null

      const t = this.publicTasks.find(x => x && x.id === id)
      if (!t || t.stage === targetStage) return

      const previous = t.stage
      t.stage = targetStage
      try {
        await this.updateTask(t)
      } catch (e) {
        t.stage = previous
        LNbits.utils.notifyApiError(e)
      }
    },
    async createTask(task) {
      try {
        const newTask = await LNbits.api.request(
          'POST',
          `/scrum/api/v1/tasks/public`,
          null,
          { task: task.name, notes: task.notes, scrum_id: this.scrumId, stage: 'todo', assignee: task.assignee, complete: false }
        )
        this.publicTasks.push(newTask)
        this.addTaskFormDialog.show = false
        this.addTaskFormDialog.data = {}
        this.$q && this.$q.notify && this.$q.notify({ type: 'positive', message: 'Task added' })
      } catch (e) {
        LNbits.utils.notifyApiError(e)
      }
    },
    async updateTask(task) {
      await LNbits.api.request(
        'PUT',
        `/scrum/api/v1/tasks/public/${task.id}`,
        null,
        { stage: task.stage, assignee: task.assignee, notes: task.notes }
      )
      const t = this.publicTasks.find(x => x && x.id === task.id)
      if (t) Object.assign(t, task)
      this.tasksFormDialog.show = false
      this.tasksFormDialog.data = {}
      this.$q && this.$q.notify && this.$q.notify({ type: 'positive', message: 'Task updated' })
    },
    editTask(t) {
      this.tasksFormDialog.data = { ...t }
      this.tasksFormDialog.show = true
    },
    addTask() {
      this.addTaskFormDialog.data = { }
      this.addTaskFormDialog.show = true
    },
    subscribeToEvents(scrumId) {
    try {
      const url = new URL(window.location)
      url.protocol = url.protocol === 'https:' ? 'wss' : 'ws'
      url.pathname = `/api/v1/ws/${scrumId}`
      const ws = new WebSocket(url)

      ws.onmessage = ({ data }) => {
        let msg
        try {
          msg = JSON.parse(data)
        } catch (e) {
          console.warn('WS non-JSON message:', data)
          return
        }
        if (Array.isArray(msg)) {
          msg.forEach(m => this.upsertTask(m.task || m))
        } else if (msg && msg.type && msg.task) {
          if (msg.type === 'task.deleted') {
            const i = this.publicTasks.findIndex(t => t.id === msg.task.id)
            if (i !== -1) this.publicTasks.splice(i, 1)
          } else {
            this.upsertTask(msg.task)
          }
        } else {
          this.upsertTask(msg)
        }
      }

      ws.onerror = err => console.warn('WS error', err)
    } catch (err) {
      console.warn(err)
      LNbits.utils.notifyApiError(err)
    }
  },
  upsertTask(task) {
    if (!task || !task.id) return
    const i = this.publicTasks.findIndex(t => t && t.id === task.id)
    if (i === -1) {
      this.publicTasks.push(task)
    } else {
      this.publicTasks.splice(i, 1, task)
    }
  },
  },
      mounted() {
        if (this.scrumId) {
          this.subscribeToEvents(this.scrumId)
        }
      }
    })
</script>

{% endblock %}
