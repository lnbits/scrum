{% extends "public.html" %} {% block page %}
<div class="row q-col-gutter-md justify-center items-stretch window-height">
  <div
    v-for="stage in stages"
    :key="stage"
    class="col-12 col-sm-6 col-md-5 col-lg-4 q-gutter-y-md column justify-between full-height"
    @dragover.prevent
    @drop="handleDrop(stage)"
  >
    <q-card class="full-height">
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none" v-text="stageLabels[stage]"></h6>
        <q-card
          class="my-card q-mb-md"
          v-for="task in tasksBy(stage)"
          :key="task.id"
          flat
          bordered
          draggable="true"
          @dragstart="onDragStart(task.id)"
        >
          <q-card-section horizontal>
            <q-card-section class="q-pt-xs">
              <div class="text-h6 q-mt-sm q-mb-xs" v-text="task.task"></div>
              <div
                class="text-caption text-grey"
                v-if="task.notes"
                v-text="task.notes"
              ></div>
            </q-card-section>
          </q-card-section>
          <q-card-actions align="right">
            <div class="on-left text-caption text-grey">
              <span v-text="task.assignee"></span>
              <span
                v-text="' for ' + task.reward.toString() + 'sats reward'"
              ></span>
            </div>
            <q-btn
              flat
              @click="editTask(task)"
              icon="edit"
              color="light-blue"
            ></q-btn>
          </q-card-actions>
        </q-card>
      </q-card-section>
    </q-card>
  </div>
  <q-dialog v-model="tasksFormDialog.show" position="top">
    <q-card
      v-if="tasksFormDialog.show"
      class="q-pa-lg q-pt-md lnbits__dialog-card q-col-gutter-md"
    >
      <q-input
        v-if="publicAssigning"
        filled
        dense
        v-model.trim="tasksFormDialog.data.assignee"
        label="Assignee (LNaddress if task has paid reward)"
      ></q-input>

      <q-input
        filled
        dense
        v-model.trim="tasksFormDialog.data.notes"
        label="Notes"
        type="textarea"
        hint="Any useful notes"
      ></q-input>

      <div class="row q-mt-lg">
        <q-btn
          @click="updateTask(tasksFormDialog.data)"
          label="Update"
          unelevated
          color="primary"
        >
        </q-btn>
        <q-btn v-close-popup flat color="grey" class="q-ml-auto">Cancel</q-btn>
      </div>
    </q-card>
  </q-dialog>
</div>
{% endblock %} {% block scripts %}
<script>
  public_page_tasks = {{ public_page_tasks | safe }}
  public_page_assigning = {{ public_page_assigning | tojson | safe }}
  scrum_id = '{{ scrum_id }}'

  window.app = Vue.createApp({
    mixins: [windowMixin],
    data() {
      return {
        scrumId: scrum_id,
        publicTasks: Array.isArray(public_page_tasks) ? public_page_tasks.filter(Boolean) : [],
        draggingTaskId: null,
        stages: ['todo','doing','done'],
        stageLabels: { todo: 'To do', doing: 'Doing', done: 'Done' },
        tasksFormDialog: { show: false, data: {} },
        publicAssigning: public_page_assigning
      }
    },
    methods: {
      tasksBy(stage) {
        return this.publicTasks.filter(t => t && t.stage === stage)
      },

      onDragStart(id) {
        this.draggingTaskId = id
      },

      async handleDrop(targetStage) {
        if (!this.draggingTaskId) return
        const id = this.draggingTaskId
        this.draggingTaskId = null

        const t = this.publicTasks.find(x => x && x.id === id)
        if (!t || t.stage === targetStage) return

        const previous = t.stage
        t.stage = targetStage
        try {
          await this.updateTask(t)
        } catch (e) {
          t.stage = previous
          LNbits.utils.notifyApiError(e)
        }
      },

      async updateTask(t) {
        await LNbits.api.request(
          'PUT',
          `/scrum/api/v1/tasks/public/${t.id}`,
          null,
          { stage: t.stage, assignee: t.assignee, notes: t.notes }
        )
        this.$q && this.$q.notify && this.$q.notify({ type: 'positive', message: 'Task updated' })
      },
      editTask(t) {
        this.tasksFormDialog.data = { ...t }
        this.tasksFormDialog.show = true
      }
    }
  })
</script>

{% endblock %}
